---
title: "Data"
author: "Daniel & Ellie"
date: "2025-03-23"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Import Data and Packages
```{r Data and Packages}
library(lubridate)
library(ggplot2)
library(forecast)
library(Kendall)
library(tseries)
library(outliers)
library(tidyverse)
library(smooth)
library(zoo)
library(kableExtra)
library(readxl)
library(dplyr)
library(cowplot)

# Assuming data folder in same location as this repo
load_data <- read_excel(path="../tsa-spring-2025/load.xlsx", col_names=TRUE)
relative_humidity_data <- read_excel(path="../tsa-spring-2025/relative_humidity.xlsx", col_names=TRUE)
temperature_data <- read_excel(path="../tsa-spring-2025/temperature.xlsx", col_names=TRUE)


# Assuming data in Downloads folder
load_data <- read_excel(path = path.expand("~/Downloads/load.xlsx"), col_names = TRUE)
relative_humidity_data <- read_excel(path = path.expand("~/Downloads/relative_humidity.xlsx"), col_names = TRUE)
temperature_data <- read_excel(path = path.expand("~/Downloads/temperature.xlsx"), col_names = TRUE)

load_data <- mutate(load_data, date = ymd(date))

# do we need this read in?
sub_template <- read_excel(path="../tsa-spring-2025/submission_template.xlsx", col_names=TRUE)
sub_template <- read_excel(path = path.expand("~/Downloads/submission_template.xlsx"), col_names = TRUE)

# Convert hourly data into daily training data (1/2005-12/2009)
training_load_data <- load_data %>% 
  filter(date < as.Date("2010-01-01")) %>%
  select(h1:h24) %>%
  rowMeans(na.rm = TRUE) %>%
  msts(seasonal.periods =c(7,365.25), start = c(2005, 1, 1))

# Without date cutoff
all_load_data <- load_data %>%
  select(h1:h24) %>%
  rowMeans(na.rm = TRUE) %>%
  msts(seasonal.periods =c(7,365.25), start=c(2005, 1))

autoplot(training_load_data)

```

# First Forecast

```{r First Forecast}


basic_forecast <- snaive(all_load_data, h = 59) # Forecasting for January and February 2011 (31+28 days)
print(basic_forecast)

# plot
autoplot(all_load_data) +
  autolayer(basic_forecast$mean, series="Seasonal Naive Forecast", PI=FALSE) +
  ylab("Daily Load") +
  xlab("Date")


# 1. Formatting the decimal dates as actual dates
forecast_values <- as.numeric(basic_forecast$mean)
start_date_forecast <- as.Date("2011-01-01")
forecast_dates <- seq(start_date_forecast, by = "day", length.out = length(forecast_values))

formatted_forecast <- data.frame(
  date = forecast_dates,
  load = forecast_values
)

print(formatted_forecast)

write.csv(formatted_forecast, "naive_forecast.csv", row.names=FALSE)

# forecast humidity + temp, then take into account
# add another variable similar to fourier terms, add to x_reg
nnetar(x_reg=c(temp, hum), )
# forecast temp and humidity separately
# forecast with nnetar again


```


# ETS Forecast

```{r}

ets_fit <- stlf(training_load_data, h=365)
autoplot(ets_fit)


autoplot(all_load_data)+
  autolayer(ets_fit)

ets_fit_all <- stlf(all_load_data, h=59)
autoplot(ets_fit_all)

# 1. Formatting the decimal dates as actual dates
forecast_values <- as.numeric(ets_fit_all$mean)
start_date_forecast <- as.Date("2011-01-01")
forecast_dates <- seq(start_date_forecast, by = "day", length.out = length(forecast_values))

formatted_forecast <- data.frame(
  date = forecast_dates,
  load = forecast_values
)

print(formatted_forecast)

write.csv(formatted_forecast, "ets.csv", row.names=FALSE)
```


# ARIMA + fourier Forecast

```{r}

arima_fit <- auto.arima(training_load_data, seasonal=FALSE, lambda=0, xreg=fourier(training_load_data, K=c(2,12)))
arima_forecast <- forecast(arima_fit, xreg=fourier(training_load_data, K=c(2,12), h=59), h=59)


best_aicc <- Inf
best_k <- NULL
best_model <- NULL

for (k1 in 1:2) {
  for (k2 in 1:12) {
    xreg <- fourier(all_load_data, K=c(k1, k2))
    fit <- auto.arima(all_load_data, seasonal=FALSE, xreg=xreg, lambda=0)
    if (fit$aicc < best_aicc) {
      best_aicc <- fit$aicc
      best_k <- c(k1, k2)
      best_model <- fit
    }
  }
}
best_k

autoplot(all_load_data)+
  autolayer(arima_forecast)

arima_fit <- auto.arima(all_load_data, seasonal=FALSE, lambda=0, xreg=fourier(all_load_data, K=best_k))
all_fit <- forecast(arima_fit, xreg=fourier(all_load_data, K=best_k, h=59), h=59)

autoplot(all_fit)

# 1. Formatting the decimal dates as actual dates
forecast_values <- as.numeric(all_fit$mean)
formatted_forecast <- data.frame(
  date = forecast_dates,
  load = forecast_values
)

print(formatted_forecast)

write.csv(formatted_forecast, "fourier.csv", row.names=FALSE)
```

# Neural network

```{r}

nnfit <- nnetar(training_load_data,
                p=1,
                P=0,
                xreg=fourier(training_load_data, K=c(2,2)))

nnfor <- forecast(nnfit, h=59, xreg=fourier(training_load_data, K=c(2,2), h=59))

best_aicc <- Inf
best_k <- NULL
best_model <- NULL

for (k1 in 1:2) {
  for (k2 in 1:12) {
    xreg <- fourier(all_load_data, K=c(k1, k2))
    fit <- auto.arima(all_load_data, seasonal=FALSE, xreg=xreg, lambda=0)
    if (fit$aicc < best_aicc) {
      best_aicc <- fit$aicc
      best_k <- c(k1, k2)
      best_model <- fit
    }
  }
}
best_k

autoplot(all_load_data)+
  autolayer(arima_forecast)

arima_fit <- auto.arima(all_load_data, seasonal=FALSE, lambda=0, xreg=fourier(all_load_data, K=best_k))
all_fit <- forecast(arima_fit, xreg=fourier(all_load_data, K=best_k, h=59), h=59)

autoplot(all_fit)

# 1. Formatting the decimal dates as actual dates
forecast_values <- as.numeric(all_fit$mean)
formatted_forecast <- data.frame(
  date = forecast_dates,
  load = forecast_values
)

print(formatted_forecast)

write.csv(formatted_forecast, "fourier.csv", row.names=FALSE)
```

```{r TBATS}
# Fit the TBATS model to the training time series
TBATS_fit <- tbats(training_load_data)

# Forecast the next 59 periods
TBATS_for <- forecast(TBATS_fit, h = 59)

# Plot forecast only
autoplot(TBATS_for) + 
  ylab("Load") +
  ggtitle("TBATS Forecast: Next 59 Periods")

# Plot full observed data with forecast
autoplot(all_load_data) +
  autolayer(TBATS_for, series = "TBATS Forecast", PI = FALSE) +
  ylab("Load") +
  ggtitle("Observed Data and TBATS Forecast (59-Step Horizon)")
```
```{r Tbats csv}
# Extract forecasted values from TBATS model
forecast_values_tbats <- as.numeric(TBATS_for$mean)
start_date_tbats <- as.Date("2011-01-01")  # Adjust as needed
forecast_dates_tbats <- seq(start_date_tbats, by = "day", length.out = length(forecast_values_tbats))
formatted_forecast_tbats <- data.frame(
  date = forecast_dates_tbats,
  load = forecast_values_tbats
)

print(formatted_forecast_tbats)
write.csv(formatted_forecast_tbats, "tbats_forecast.csv", row.names = FALSE)

```
NN 2,6
```{r}
# Fit the Neural Network Model with Fourier terms
NN_fit_26 <- nnetar(training_load_data,
                    p = 1,
                    P = 1,
                    xreg = fourier(training_load_data, K = c(2, 6)))

# Create future Fourier terms for 59-day forecast horizon
future_fourier <- fourier(training_load_data, K = c(2, 6), h = 59)

# Forecast using the fitted neural net model
NN_forec_26 <- forecast(NN_fit_26, h = 59, xreg = future_fourier)

# Plot the forecasted values
autoplot(NN_forec_26) +
  ylab("Load") +
  ggtitle("Neural Network Forecast (59 Days)")

# Plot the model forecast with full observed series
autoplot(all_load_data) +  # assuming this is the full time series
  autolayer(NN_forec_26, series = "Neural Network", PI = FALSE) +
  ylab("Load") +
  ggtitle("Observed Data and NN Forecast")

```
```{r NN 26 csv}
# Extract forecasted values from Neural Network model
forecast_values_nn <- as.numeric(NN_forec_26$mean)

# Set forecast start date
start_date_nn <- as.Date("2011-01-01")  # Adjust as needed to match your dataset

# Create forecast date sequence
forecast_dates_nn <- seq(start_date_nn, by = "day", length.out = length(forecast_values_nn))

# Format into a data frame
formatted_forecast_nn <- data.frame(
  date = forecast_dates_nn,
  load = forecast_values_nn
)

# Print and export to CSV
print(formatted_forecast_nn)
write.csv(formatted_forecast_nn, "nn_forecast26.csv", row.names = FALSE)

```

NN 36
```{r}
# Fit the Neural Network Model with Fourier terms (K = 3, 6)
NN_fit_36 <- nnetar(training_load_data,
                    p = 1,
                    P = 1,
                    xreg = fourier(training_load_data, K = c(3, 6)))

# Create future Fourier terms for 59-day forecast horizon
future_fourier_36 <- fourier(training_load_data, K = c(3, 6), h = 59)

# Forecast using the fitted neural net model
NN_forec_36 <- forecast(NN_fit_36, h = 59, xreg = future_fourier_36)

# Plot the forecasted values
autoplot(NN_forec_36) +
  ylab("Load") +
  ggtitle("Neural Network Forecast (59 Days) with K = c(3, 6)")

# Plot the model forecast with full observed series
autoplot(all_load_data) +  # assuming this is the full time series
  autolayer(NN_forec_36, series = "Neural Network", PI = FALSE) +
  ylab("Load") +
  ggtitle("Observed Data and Neural Network Forecast (K = c(3, 6))")

```
NN 36 CSV
```{r}
# Extract forecasted values from Neural Network model with K = c(3, 6)
forecast_values_nn_36 <- as.numeric(NN_forec_36$mean)

# Set forecast start date
start_date_nn_36 <- as.Date("2011-01-01")  # Adjust as needed to match your dataset

# Create forecast date sequence
forecast_dates_nn_36 <- seq(start_date_nn_36, by = "day", length.out = length(forecast_values_nn_36))

# Format into a data frame
formatted_forecast_nn_36 <- data.frame(
  date = forecast_dates_nn_36,
  load = forecast_values_nn_36
)

# Print and export to CSV
print(formatted_forecast_nn_36)
write.csv(formatted_forecast_nn_36, "nn_forecast36.csv", row.names = FALSE)

```

